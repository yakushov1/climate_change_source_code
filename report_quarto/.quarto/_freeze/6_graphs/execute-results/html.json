{
  "hash": "8d6b6b26a18aef2f2123c4f396fe4a4b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Графики\"\nauthor: \"Vasily Yakushov\"\nformat: \n  html: \n    code-fold: true\n    code-tools: true\n---\n\n\n\nИсходный код всех необходимых графиков. Написаны шаблоны графиков, которые применяются к данным с различных метеостанций, затем графики сохраняются в отдельные png-файлы автоматически.\n\n### Шаг 1: Загрузка необходимых пакетов\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(patchwork)\nlibrary(ggpmisc) # для добавления линии регрессии на график\n```\n:::\n\n\n\n### Шаг 2: Импортируем все необходимые csv\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Import ------------------------------------------------------------------\nseven_station_monthly <- read_csv2(\"../initial_data/climate/cleaned/monthly_anomaly.csv\")\nseven_station_annualy <- read_csv2(\"../initial_data/climate/cleaned/annualy_anomaly.csv\")\n\nstation_name <- levels(as.factor(seven_station_annualy$Station))\n\n#Сезоны, выделенные по переходу температур/снега через 0\nseason_by_temperature <- read_csv2(\"../initial_data/climate/cleaned/season_by_temperature.csv\")\nseason_by_snow <- read_csv2(\"../initial_data/climate/cleaned/season_by_snow.csv\")\n\n#Оттаивание-замерзание\nmelt_freeze_all_winter <- read_csv2(\"../initial_data/climate/cleaned/melt_freeze_by_month.csv\")\n\n\n# Количество дней с \"плохим\" снежным покровом по всем станциям\nbad_snow <- read_csv2(\"../initial_data/climate/cleaned/all_station_bad_snow.csv\")\n```\n:::\n\n\n\n### Шаблоны графиков\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Templates ---------------------------------------------------------------\n# шаблон для графика\n# df - входной датасет\n# x - параметр, который будет отображаться по оси X \n# red_line - параметр для красной линии (линия линейной регрессии) и т.д.\n# y_labs - подпись к оси Y\n# col_or_line - график столбчатый или линейный?\n# см реальные примеры ниже\n\ntemplate <- function(df, x, red_line, gray_line, blue_line,\n                     y_labs, col_or_line, color_of_col){\n  \n  # Выбор: столбчатый или линейный график? \n  geometry <- function(col_or_line, color_of_col){\n    if (col_or_line == \"col\"){\n      list(geom_col(aes(y={{ gray_line }}), alpha=0.2, fill = color_of_col))\n    }\n    else {\n      list(geom_line(aes({{ x }}, {{ gray_line }}), alpha = 0.2))\n    }\n  }\n  \n  ggplot(df, aes(x = {{ x }}, y = {{ red_line }}))+\n    geometry(col_or_line, color_of_col)+\n    geom_line(aes({{ x }}, {{ blue_line }}), color = \"#4682B4\", linewidth = 1.1)+\n    stat_poly_line(color = \"red\", alpha = 0.5, na.rm = T)+\n    stat_poly_eq(use_label(\"eq\"), na.rm = T)+\n    stat_poly_eq(use_label(c(\"R2\",\"p\")), label.y = 0.9, na.rm = T)+\n    theme_minimal()+\n    labs(x = \"Год\",\n         y = y_labs)+\n    scale_y_continuous(labels = scales::label_number(accuracy = 1))\n}\n\n\n# график, когда сверху на всю ширину годовые значения,\n# а ниже панелями - среднемесячные\n# графики будут сохранены в папки внутри images\n# кроме того, сохраняет параметры линии тренда в отдельные csv \n# путь см в теле функции\n# выдаст ошибку, если требуемых папок не существует\n# df_annualy - датафрейм с годовыми значениями\n# df_monthly - датафрейм с месячными значениями\n# station - название станции (датафрейм фильтруется по названиям станций,\n# оно также фигурирует в названии выходных файлов)\n# остальные аргументы требуются для образца template (функция выше)\n# кроме prefix - фигурирует в именах выходных папок, чтобы не запутаться\n# и print_plot - показывать (T) или нет(F, default) график в RSTudio?\n\nann_monthly_graph <- function(df_annualy, df_monthly, station, x,\n                    red_line, gray_line, blue_line, y_labs, prefix,\n                    col_or_line, color_of_col = \"black\",\n                    print_plot = F){\n  \n  annualy <- df_annualy |> \n    filter(Station == station) |> \n    filter(Year != 2023) |>\n    template(x = {{x}},\n             red_line = {{ red_line }},\n             gray_line = {{ gray_line }},\n             blue_line  = {{ blue_line }},\n             y_labs = y_labs,\n             col_or_line = col_or_line,\n             color_of_col = color_of_col)+\n    labs(x = NULL,\n         y = NULL)\n  \n  monthly <- df_monthly |> \n    filter(Station == station) |>\n    filter(Year != 2023) |>\n    template(x = {{x}},\n             red_line = {{ red_line }},\n             gray_line = {{ gray_line }},\n             blue_line  = {{ blue_line }},\n             y_labs = y_labs,\n             col_or_line = col_or_line,\n             color_of_col = color_of_col)+\n    facet_wrap(.~Month, scales = \"free\")+\n    theme(axis.text.x = element_text(angle = 60))\n  \n  total_graph <- annualy / monthly +\n    plot_layout(heights = c(1, 3))\n  \n  \n  \n  # ggsave(total_graph, file= paste(\"images/climate/\", prefix, \"/\", station, \"_\",  prefix, \"_graph.png\", sep=\"\"),\n  #        device = png,\n  #        width = 2480, height = 3100, units = \"px\")\n  \n  print(paste(\"График для станции \", station, \" сохранен\"))\n  if(print_plot){\n    print(total_graph)\n  }\n  \n  #Выгрузка параметров линейного тренда\n  monthly_ <- ggplot_build(monthly)\n  monthly_parametr <- tibble(Month = levels(monthly_$data[[1]]$PANEL),\n                             RR = monthly_$data[[4]]$rr.label, \n                             EQ = monthly_$data[[4]]$eq.label,\n                             P = round(monthly_$data[[4]]$p.value, 5),\n                             Station = station) |>\n    separate_wider_delim(RR, delim='\"', names=c('x','r'), too_many = \"drop\" ) |> \n    mutate(b = str_sub(EQ, start = -20, end = -12)) |> \n    mutate(b = str_remove_all(b, \"[ +]\")) |> \n    mutate(b = str_remove(b, '^\\\\.')) |> \n    mutate(Parametr = prefix) |>\n    select(Station, Parametr, Month, RR = r, P, b) |> \n    mutate_all(type.convert, as.is = T)\n  \n # write_csv(monthly_parametr, file = paste(\"../initial_data/climate/cleaned/trends/monthly_\",                                            prefix, \"/\", station, \"_trends.csv\", sep = \"\"))\n  print(paste(\"параметры тренда по станции\", station,  \"сохранены в файл\"))\n}\n```\n:::\n\n\n\n### Средние температуры\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# построит графики для всех метеостанций из вектора station_name:\n# station_name |> map(\\(x) ann_monthly_graph(df_annualy = seven_station_annualy,\n#                                            df_monthly = seven_station_monthly,\n#                                            station = x,\n#                                            x=Year,\n#                                            red_line=Tavg_roll_mean_from_1976,\n#                                            gray_line = Tavg,\n#                                            blue_line = Tavg_roll_mean,\n#                                            y_labs = \"Температура приземного воздуха, [\\u00B0C]\",\n#                                            prefix = \"tavg\",\n#                                            col_or_line = \"line\"), .progress=T)\n\n\n# пример графика\nann_monthly_graph(df_annualy = seven_station_annualy,\n                  df_monthly = seven_station_monthly,\n                  station = \"bakhta\",\n                  x=Year,\n                  red_line=Tavg_roll_mean_from_1976,\n                  gray_line = Tavg,\n                  blue_line = Tavg_roll_mean,\n                  y_labs = \"Температура приземного воздуха, [\\u00B0C]\",\n                  prefix = \"tavg\",\n                  col_or_line = \"line\",\n                  print_plot = T)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"График для станции  bakhta  сохранен\"\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](6_graphs_files/figure-html/unnamed-chunk-4-1.png){width=960}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"параметры тренда по станции bakhta сохранены в файл\"\n```\n\n\n:::\n:::\n\n\n\n### Среднесезонные температуры (сезоны выделены по температурам)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# данные есть только для 1 метеостанции, поэтому map не использую\ntavg_by_season <- season_by_temperature|>\n  filter(Year != 2023) |>\n  mutate(Season = factor(Season, labels = c(\"Осень\", \"Весна\", \"Лето\", \"Зима\"))) |> \n  template(x=Year,\n           red_line=Tavg_roll_mean,\n           gray_line = Tavg,\n           blue_line = Tavg_roll_mean,\n           y_labs = \"Температура приземного воздуха, [\\u00B0C]\",\n           col_or_line = \"line\")+\n  facet_wrap(.~Season, scales = \"free_y\")\n\nprint(tavg_by_season)\n```\n\n::: {.cell-output-display}\n![](6_graphs_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# ggsave(tavg_by_season, file= \"images/climate/season/tavg_by_season(by_temperature).png\", device = png,\n#        width = 2000, height = 1500, units = \"px\", bg = \"white\")\n```\n:::\n\n\n\n### Температурные аномалии\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# построит графики для всех метеостанций из вектора station_name:\n\n# station_name |> map(\\(x) ann_monthly_graph(seven_station_annualy,\n#                                  seven_station_monthly,\n#                                  station = x,\n#                                  x=Year,\n#                                  red_line=T_anomaly_roll_mean_from_1976,\n#                                  gray_line = T_anomaly,\n#                                  blue_line = T_anomaly_roll_mean,\n#                                  y_labs = \"Отклонения от среднего за 1961-1990 гг., [\\u00B0C]\",\n#                                  prefix = \"t_anomaly\",\n#                                  col_or_line = \"line\"), .progress=T)\n\n# пример графика\nann_monthly_graph(seven_station_annualy,\n                  seven_station_monthly,\n                  station = \"bakhta\",\n                  x=Year,\n                  red_line=T_anomaly_roll_mean_from_1976,\n                  gray_line = T_anomaly,\n                  blue_line = T_anomaly_roll_mean,\n                  y_labs = \"Отклонения от среднего за 1961-1990 гг., [\\u00B0C]\",\n                  prefix = \"t_anomaly\",\n                  col_or_line = \"line\",\n                  print_plot = T)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"График для станции  bakhta  сохранен\"\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](6_graphs_files/figure-html/unnamed-chunk-6-1.png){width=960}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"параметры тренда по станции bakhta сохранены в файл\"\n```\n\n\n:::\n:::\n\n\n\n### Суммы осадков\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# есть данные только по 1 станции, поэтому без map\nann_monthly_graph(seven_station_annualy,\n                                 seven_station_monthly,\n                                 station = \"bakhta\",\n                                 x=Year,\n                                 red_line=Pr_roll_mean_from_1976,\n                                 gray_line = Pr,\n                                 blue_line = Pr_roll_mean,\n                                 y_labs = \"Сумма осадков, мм\",\n                                 prefix = \"pr\",\n                                 col_or_line = \"col\",\n                                print_plot = T)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"График для станции  bakhta  сохранен\"\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](6_graphs_files/figure-html/unnamed-chunk-7-1.png){width=960}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"параметры тренда по станции bakhta сохранены в файл\"\n```\n\n\n:::\n:::\n\n\n\n### Суммы осадков по сезонам\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npr_by_season <- season_by_temperature|>\n  filter(Year != 2023) |>\n  mutate(Season = factor(Season, labels = c(\"Осень\", \"Весна\",\"Лето\", \"Зима\"))) |> \n  template(x=Year,\n           red_line=Pr_sum_roll_mean,\n           gray_line = Pr_sum,\n           blue_line = Pr_sum_roll_mean,\n           y_labs = \"Сумма осадков, мм\",\n           col_or_line = \"col\",\n           color_of_col = \"black\")+\n  facet_wrap(.~Season, scales = \"free_y\")\n\nprint(pr_by_season)\n```\n\n::: {.cell-output-display}\n![](6_graphs_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# ggsave(pr_by_season, file= \"images/climate/season/pr_by_season(by_temperature).png\", device = png,\n#        width = 2000, height = 1600, units = \"px\", bg = \"white\")\n```\n:::\n\n\n\n### Аномалии осадков\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# данные только для 1 метеостанции\nann_monthly_graph(seven_station_annualy,\n                  seven_station_monthly,\n                  station = \"bakhta\",\n                  x=Year,\n                  red_line=Pr_anomaly_roll_mean_from_1976,\n                  gray_line = Pr_anomaly,\n                  blue_line = Pr_anomaly_roll_mean,\n                  y_labs = \"Отклонения от среднего за 1961-1990 гг., мм\",\n                  prefix = \"pr_anomaly\",\n                  col_or_line = \"col\",\n                  print_plot = T)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"График для станции  bakhta  сохранен\"\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](6_graphs_files/figure-html/unnamed-chunk-9-1.png){width=960}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"параметры тренда по станции bakhta сохранены в файл\"\n```\n\n\n:::\n:::\n\n\n\n### Глубина снежного покрова\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# данные только для 1 метеостанции\nann_monthly_graph(seven_station_annualy,\n                  seven_station_monthly |>  filter(!(Month %in% (6:8))),\n                  station = \"bakhta\",\n                  x=Year,\n                  red_line=Sn_roll_mean_from_1976,\n                  gray_line = Sn,\n                  blue_line = Sn_roll_mean,\n                  y_labs = \"Глубина снежного покрова, см\",\n                  prefix = \"sn\",\n                  col_or_line = \"col\",\n                  color_of_col = \"#4682B4\",\n                  print_plot = T)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"График для станции  bakhta  сохранен\"\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](6_graphs_files/figure-html/unnamed-chunk-10-1.png){width=960}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"параметры тренда по станции bakhta сохранены в файл\"\n```\n\n\n:::\n:::\n\n\n\n### Глубина снежного покрова по сезонам\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsn_by_season <- season_by_temperature|>\n  filter(Year != 2023, Season != \"Summer\") |>\n  mutate(Season = factor(Season, labels = c(\"Осень\", \"Весна\", \"Зима\"))) |> \n  template(x=Year,\n           red_line=Sn_avg_roll_mean,\n           gray_line = Sn_avg,\n           blue_line = Sn_avg_roll_mean,\n           y_labs = \"Глубина снежного покрова, см\",\n           col_or_line = \"col\",\n           color_of_col = \"#4682B4\")+\n  facet_wrap(.~Season, scales = \"free_y\")\n\nprint(sn_by_season)\n```\n\n::: {.cell-output-display}\n![](6_graphs_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# ggsave(sn_by_season, file= \"images/climate/season/sn_by_season(by_temperature).png\", device = png,\n#        width = 2000, height = 1000, units = \"px\", bg = \"white\")\n```\n:::\n\n\n\n### Аномалии глубины снежного покрова\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nann_monthly_graph(seven_station_annualy,\n                  seven_station_monthly |>  filter(!(Month %in% (6:8))),\n                  station = \"bakhta\",\n                  x=Year,\n                  red_line=Sn_anomaly_roll_mean_from_1976,\n                  gray_line = Sn_anomaly,\n                  blue_line = Sn_anomaly_roll_mean,\n                  y_labs = \"Глубина снежного покрова, см\",\n                  prefix = \"sn_anomaly\",\n                  col_or_line = \"col\",\n                  color_of_col = \"#4682B4\",\n                  print_plot = T)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"График для станции  bakhta  сохранен\"\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](6_graphs_files/figure-html/unnamed-chunk-12-1.png){width=960}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"параметры тренда по станции bakhta сохранены в файл\"\n```\n\n\n:::\n:::\n\n\n\n### Продолжительность сезонов (выделены по температурам)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nduration_of_season_by_temp <- season_by_temperature|>\n  filter(Year != 2023) |>\n  mutate(Season = factor(Season, labels = c(\"Осень\", \"Весна\", \"Лето\", \"Зима\"))) |> \n  ggplot(aes(Year, Duration_roll_mean))+\n  geom_col(aes(y = Duration), fill = \"lightblue\", alpha = 0.5)+\n  geom_line(aes(y = Duration_roll_mean), col = \"red\", linewidth = 1.2)+\n  facet_wrap(.~Season, scales = \"free_y\")+\n  theme_minimal()+\n  labs(x = \"Год\",\n       y = \"Продолжительность, дней\")\n\nprint(duration_of_season_by_temp)\n```\n\n::: {.cell-output-display}\n![](6_graphs_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# ggsave(duration_of_season_by_temp, file= \"images/climate/season/duration_of_season_by_temp.png\", device = png,\n#        width = 2000, height = 1500, units = \"px\", bg = \"white\")\n```\n:::\n\n\n\n### Оттаивание-замерзание\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmelt_freeze_by_month_graph <- ggplot(melt_freeze_all_winter, aes(Year, Melt_freeze))+\n  geom_col()+\n  facet_wrap(.~Month)+\n  theme_minimal()+\n  labs(x=\"Год\",\n       y = 'Количество переходов \"замерзание-оттаивание\"')\n\nprint(melt_freeze_by_month_graph)\n```\n\n::: {.cell-output-display}\n![](6_graphs_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# ggsave(melt_freeze_by_month_graph, file= \"images/climate/melt_freeze_by_month_graph.png\", device = png,\n#        width = 2481, height = 1500, units = \"px\", bg = \"white\")\n```\n:::\n\n\n\n### Количество дней с \"плохим\" снегом по всем станциям (с 2005 года)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseven_station_graph <- bad_snow |> \n  mutate(Station = factor(Station, levels = c(\"Игарка\", \"Туруханск\", \"Верхнеимбатск\",\n                                              \"Бахта\", \"Бор\", \"Ворогово\", \"Ярцево\"))) |> \n  ggplot(aes(Year, count))+\n  geom_col(fill=\"lightblue\")+\n  facet_wrap(.~Station, ncol = 1)+\n  theme_bw()+\n  labs(x = \"Год\",\n       y = \"Количество дней, когда снег покрывал  <50% поверхности почвы\")+\n  coord_cartesian(xlim = c(2005,2023 ))+\n  theme_minimal()\n\nprint(seven_station_graph)\n```\n\n::: {.cell-output-display}\n![](6_graphs_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# ggsave(seven_station_graph, filename=\"images/climate/bad_snow_by_station.png\",\n#        width = 1000, height = 2500, units = \"px\", bg = \"white\")  \n```\n:::\n",
    "supporting": [
      "6_graphs_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}