{
  "hash": "ba247b6094d83763f173dd324a7c25fc",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Соотнесение информации о снежном покрове, полученной из различных источников\"\nauthor: \"Vasily Yakushov\"\nformat: \n  html: \n    code-fold: true\n    code-tools: true\n---\n\n\n\n\nДанные о степени покрытия почвы снегом до 2005 года записаны в виде баллов: 1 балл = 10% покрытия почвы снегом. А после 2005 года - в виде текстового описания. Данные были упрощены до 2 градаций: снег покрывает более или менее половины поверхности почвы. Задача: соотносятся ли результаты из разных источников?\n\\ Схема решения следующая: сначала обучаем модель на тренировочной выборке (данные после 2005 года, проверям на валидационной части выборки (оставшиеся данные после 2005 года)). Затем проверям предсказания модели на тестовой выборке (данные до 2005 года, целевая переменная в которой была в виде баллов), если точность высокая, то данные сопоставимы.\\\nВ качестве модели был выбран catboost, расчеты реализованы на python\n\n### Шаг 1: Загрузка необходимых библиотек.\n\n::: {#f6f7aa1b .cell execution_count=1}\n``` {.python .cell-code}\nimport pandas as pd\nfrom catboost import CatBoostClassifier\nfrom catboost import Pool\nimport shap\nimport matplotlib.pyplot as pl\nimport matplotlib\nfrom matplotlib.ticker import NullLocator\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.metrics import accuracy_score, precision_score\nfrom catboost.utils import get_roc_curve\nimport sklearn\nfrom sklearn import metrics\nimport matplotlib.pyplot as plt\n```\n:::\n\n\n### Шаг 2: Загрузка данных\n\n::: {#943b59d6 .cell execution_count=2}\n``` {.python .cell-code}\ndata = pd.read_csv(\"../initial_data/climate/snow__quality_with_other_parametrs.csv\", sep = ';', decimal = ',')\ndata = data[(data['Month']>=9) | (data['Month']<=5)] # отберем данные только за зимний период\nnew_data = data[((data['Year']==2005) & (data['Month']>1)) | (data['Year']>2005)]\nold_data = data[(data['Year']<2005)]\nX_new = new_data.drop(['Sn_quality', 'Date', 'Year', 'Day', 'Month'], axis=1)\ny_new = new_data['Sn_quality']\n```\n:::\n\n\n### Шаг 3: Тренировочная и валидационная выборки на данных после 2005 года\n\n::: {#5f07ab06 .cell execution_count=3}\n``` {.python .cell-code}\nX_train, X_val, y_train, y_val = train_test_split(X_new, y_new, test_size=0.2, random_state=42)\n```\n:::\n\n\n### Шаг 4: Тестовая часть выборки - данные до 2005 года\n\n::: {#f1c6d108 .cell execution_count=4}\n``` {.python .cell-code}\nX_test = old_data.drop(['Sn_quality', 'Date', 'Year', 'Day', \"Month\"], axis=1)\ny_test = old_data['Sn_quality']\n```\n:::\n\n\n### Шаг 5: Построение модели\n\n::: {#71a56a86 .cell execution_count=5}\n``` {.python .cell-code}\nmodel_with_early_stop=CatBoostClassifier(\n    eval_metric='AUC',\n    iterations=200,\n    random_seed=63,\n    learning_rate=0.3,\n    early_stopping_rounds=20)\nmodel_with_early_stop.fit(\n    X_train,y_train,\n    eval_set=(X_val, y_val),\n    verbose=False,\n    plot=True\n)\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<script type=\"application/vnd.jupyter.widget-view+json\">\n{\"model_id\":\"3d8362bcb9ba42a187bc7eead04d11a9\",\"version_major\":2,\"version_minor\":0,\"quarto_mimetype\":\"application/vnd.jupyter.widget-view+json\"}\n</script>\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=5}\n```\n<catboost.core.CatBoostClassifier at 0x281255b56a0>\n```\n:::\n:::\n\n\n### Шаг 6: Оценка модели на валидационной (слева) и тестовой (справа) выборке\n\n::: {#c819f7c6 .cell execution_count=6}\n``` {.python .cell-code}\n# оценка на валидационной выборке\nplt.figure(figsize=(8,5))\nlw=2\nplt.subplot(1, 2, 1)\neval_pool = Pool(X_val, y_val)\ncurve = get_roc_curve(model_with_early_stop, eval_pool)\n(fpr, tpr, thresholds)=curve\nroc_auc=sklearn.metrics.auc(fpr, tpr)\n\nplt.plot(fpr, tpr, color='darkorange',\n         lw=lw, label='ROC curve (area = %0.2f)' % roc_auc, alpha=0.5)\n\nplt.plot([0, 1], [0, 1], color='navy', lw=lw, linestyle='--', alpha=0.5)\n\nplt.xlim([0.0, 1.0])\nplt.ylim([0.0, 1.05])\nplt.xticks(fontsize=8)\nplt.yticks(fontsize=8)\nplt.grid(True)\nplt.ylabel('True Positive Rate', fontsize=8)\nplt.title('A', fontsize=8)\nplt.legend(loc=\"lower right\", fontsize=8)\n\n\n\n# оценка на тестовой  выборке\npl.subplot(1, 2, 2)\neval_pool = Pool(X_test, y_test )\ncurve = get_roc_curve(model_with_early_stop, eval_pool)\n(fpr, tpr, thresholds)=curve\nroc_auc=sklearn.metrics.auc(fpr, tpr)\nplt.plot(fpr, tpr, color='darkorange',\n         lw=lw, label='ROC curve (area = %0.2f)' % roc_auc, alpha=0.5)\n\nplt.plot([0, 1], [0, 1], color='navy', lw=lw, linestyle='--', alpha=0.5)\n\nplt.xlim([0.0, 1.0])\nplt.ylim([0.0, 1.05])\nplt.xticks(fontsize=8)\nplt.yticks(fontsize=8)\nplt.grid(True)\nplt.title('Б', fontsize=8)\n\nplt.legend(loc=\"lower right\", fontsize=8)\ntxt=\"False Positive Rate\"\nplt.figtext(0.5, 0.01, txt, wrap=True, horizontalalignment='center', fontsize=10)\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![](4_1_why_bad_snow(catboost)_files/figure-html/cell-7-output-1.png){width=665 height=456}\n:::\n:::\n\n\nВидим, что площадь под кривой в обоих случаях большая (0.97 на валидации и 0.96 на тестовой выборке), следовательно, делаем вывод, что данные из разных источников хорошо соотносятся друг с другом.\n\n",
    "supporting": [
      "4_1_why_bad_snow(catboost)_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n<script src=\"https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js\" crossorigin=\"anonymous\"></script>\n"
      ],
      "include-after-body": [
        "<script type=application/vnd.jupyter.widget-state+json>\n{\"state\":{\"29eea592a5354988a2cf1aba21d1f000\":{\"model_module\":\"@jupyter-widgets/base\",\"model_module_version\":\"2.0.0\",\"model_name\":\"LayoutModel\",\"state\":{\"_model_module\":\"@jupyter-widgets/base\",\"_model_module_version\":\"2.0.0\",\"_model_name\":\"LayoutModel\",\"_view_count\":null,\"_view_module\":\"@jupyter-widgets/base\",\"_view_module_version\":\"2.0.0\",\"_view_name\":\"LayoutView\",\"align_content\":null,\"align_items\":null,\"align_self\":\"stretch\",\"border_bottom\":null,\"border_left\":null,\"border_right\":null,\"border_top\":null,\"bottom\":null,\"display\":null,\"flex\":null,\"flex_flow\":null,\"grid_area\":null,\"grid_auto_columns\":null,\"grid_auto_flow\":null,\"grid_auto_rows\":null,\"grid_column\":null,\"grid_gap\":null,\"grid_row\":null,\"grid_template_areas\":null,\"grid_template_columns\":null,\"grid_template_rows\":null,\"height\":\"500px\",\"justify_content\":null,\"justify_items\":null,\"left\":null,\"margin\":null,\"max_height\":null,\"max_width\":null,\"min_height\":null,\"min_width\":null,\"object_fit\":null,\"object_position\":null,\"order\":null,\"overflow\":null,\"padding\":null,\"right\":null,\"top\":null,\"visibility\":null,\"width\":null}},\"3d8362bcb9ba42a187bc7eead04d11a9\":{\"model_module\":\"catboost-widget\",\"model_module_version\":\"^1.0.0\",\"model_name\":\"CatboostWidgetModel\",\"state\":{\"_dom_classes\":[],\"_model_module\":\"catboost-widget\",\"_model_module_version\":\"^1.0.0\",\"_model_name\":\"CatboostWidgetModel\",\"_view_count\":null,\"_view_module\":\"catboost-widget\",\"_view_module_version\":\"^1.0.0\",\"_view_name\":\"CatboostWidgetView\",\"data\":{\"catboost_info\":{\"content\":{\"data\":{\"iterations\":[{\"iteration\":0,\"learn\":[0.2431130139],\"passed_time\":0.1378254624,\"remaining_time\":27.42726703,\"test\":[0.9186725295,0.2457742929]},{\"iteration\":1,\"learn\":[0.1095576399],\"passed_time\":0.141406595,\"remaining_time\":13.99925291,\"test\":[0.9571661423,0.1132933627]},{\"iteration\":2,\"learn\":[0.08250579762],\"passed_time\":0.1448834067,\"remaining_time\":9.514010374,\"test\":[0.9449603882,0.08814008743]},{\"iteration\":3,\"learn\":[0.07162496589],\"passed_time\":0.1485870743,\"remaining_time\":7.280766639,\"test\":[0.9511769834,0.07985933092]},{\"iteration\":4,\"learn\":[0.0620158144],\"passed_time\":0.1518631078,\"remaining_time\":5.922661205,\"test\":[0.9543989993,0.07184860035]},{\"iteration\":5,\"learn\":[0.05896151404],\"passed_time\":0.1549652565,\"remaining_time\":5.010543293,\"test\":[0.9565596452,0.06936880526]},{\"iteration\":6,\"learn\":[0.05703137197],\"passed_time\":0.1580319133,\"remaining_time\":4.35716561,\"test\":[0.95752625,0.06802633986]},{\"iteration\":7,\"learn\":[0.05400538891],\"passed_time\":0.161827759,\"remaining_time\":3.883866216,\"test\":[0.9578674046,0.06764173317]},{\"iteration\":8,\"learn\":[0.05217136711],\"passed_time\":0.165135418,\"remaining_time\":3.504540538,\"test\":[0.956976612,0.06725806406]},{\"iteration\":9,\"learn\":[0.05035249506],\"passed_time\":0.1685181336,\"remaining_time\":3.201844538,\"test\":[0.9592699291,0.06684710821]},{\"iteration\":10,\"learn\":[0.04922615532],\"passed_time\":0.1718819906,\"remaining_time\":2.953245111,\"test\":[0.9596868959,0.06546063448]},{\"iteration\":11,\"learn\":[0.04847955006],\"passed_time\":0.1753322916,\"remaining_time\":2.746872569,\"test\":[0.960331299,0.06536400024]},{\"iteration\":12,\"learn\":[0.0464495625],\"passed_time\":0.1796571873,\"remaining_time\":2.584299541,\"test\":[0.9607482658,0.06435449926]},{\"iteration\":13,\"learn\":[0.04571576414],\"passed_time\":0.1834552481,\"remaining_time\":2.43733401,\"test\":[0.9605587355,0.06361799574]},{\"iteration\":14,\"learn\":[0.04470136776],\"passed_time\":0.1868560015,\"remaining_time\":2.304557352,\"test\":[0.9606724537,0.06349909772]},{\"iteration\":15,\"learn\":[0.04419206217],\"passed_time\":0.1902208805,\"remaining_time\":2.187540126,\"test\":[0.961942307,0.06248289144]},{\"iteration\":16,\"learn\":[0.04379182207],\"passed_time\":0.1944791321,\"remaining_time\":2.093510657,\"test\":[0.9602365339,0.06280487663]},{\"iteration\":17,\"learn\":[0.04266666068],\"passed_time\":0.197888907,\"remaining_time\":2.000876726,\"test\":[0.9604260642,0.06271143832]},{\"iteration\":18,\"learn\":[0.04153234751],\"passed_time\":0.2011437763,\"remaining_time\":1.916159132,\"test\":[0.9598195671,0.06215186763]},{\"iteration\":19,\"learn\":[0.04098920038],\"passed_time\":0.2043961185,\"remaining_time\":1.839565066,\"test\":[0.9602365339,0.0621323818]},{\"iteration\":20,\"learn\":[0.04027306657],\"passed_time\":0.2079347335,\"remaining_time\":1.772396062,\"test\":[0.9600470035,0.06281039174]},{\"iteration\":21,\"learn\":[0.03965518452],\"passed_time\":0.2113499656,\"remaining_time\":1.710013358,\"test\":[0.9600849096,0.06359238203]},{\"iteration\":22,\"learn\":[0.03870803947],\"passed_time\":0.2147720343,\"remaining_time\":1.652810873,\"test\":[0.9601607217,0.06326653954]},{\"iteration\":23,\"learn\":[0.03814119656],\"passed_time\":0.2179933449,\"remaining_time\":1.598617863,\"test\":[0.9594026004,0.06321662268]},{\"iteration\":24,\"learn\":[0.03732543921],\"passed_time\":0.2214986508,\"remaining_time\":1.550490556,\"test\":[0.9595163186,0.06315579814]},{\"iteration\":25,\"learn\":[0.0367144043],\"passed_time\":0.2250896305,\"remaining_time\":1.506369066,\"test\":[0.9657708199,0.06268949857]},{\"iteration\":26,\"learn\":[0.03626711838],\"passed_time\":0.2285286648,\"remaining_time\":1.464276259,\"test\":[0.9662256927,0.06253815275]},{\"iteration\":27,\"learn\":[0.03557119406],\"passed_time\":0.2317238071,\"remaining_time\":1.423446244,\"test\":[0.9671354384,0.06186683481]},{\"iteration\":28,\"learn\":[0.03497768328],\"passed_time\":0.2350107248,\"remaining_time\":1.385752895,\"test\":[0.9672870627,0.06179255289]},{\"iteration\":29,\"learn\":[0.03429051233],\"passed_time\":0.2384554076,\"remaining_time\":1.35124731,\"test\":[0.9698646753,0.06185231304]},{\"iteration\":30,\"learn\":[0.03394579772],\"passed_time\":0.2419262369,\"remaining_time\":1.318888195,\"test\":[0.9695614268,0.06273176842]},{\"iteration\":31,\"learn\":[0.03337994755],\"passed_time\":0.2452163061,\"remaining_time\":1.287385607,\"test\":[0.9717978848,0.06275529149]},{\"iteration\":32,\"learn\":[0.03285730396],\"passed_time\":0.248521448,\"remaining_time\":1.257669146,\"test\":[0.971873697,0.06263857601]},{\"iteration\":33,\"learn\":[0.03257467099],\"passed_time\":0.2518841219,\"remaining_time\":1.229787184,\"test\":[0.9719495091,0.06287415414]},{\"iteration\":34,\"learn\":[0.03205735032],\"passed_time\":0.2559279474,\"remaining_time\":1.206517466,\"test\":[0.9722906637,0.06283596501]},{\"iteration\":35,\"learn\":[0.03139246311],\"passed_time\":0.2595553553,\"remaining_time\":1.182418841,\"test\":[0.9722527577,0.06219456995]},{\"iteration\":36,\"learn\":[0.03070027531],\"passed_time\":0.2632087402,\"remaining_time\":1.159541207,\"test\":[0.9713619651,0.06305200342]},{\"iteration\":37,\"learn\":[0.0302288381],\"passed_time\":0.2664934227,\"remaining_time\":1.136103539,\"test\":[0.9710208104,0.06338324352]},{\"iteration\":38,\"learn\":[0.02957215814],\"passed_time\":0.2698675346,\"remaining_time\":1.11406854,\"test\":[0.9717031197,0.06203980571]},{\"iteration\":39,\"learn\":[0.02933734459],\"passed_time\":0.2745981013,\"remaining_time\":1.098392405,\"test\":[0.9734847049,0.06201194019]},{\"iteration\":40,\"learn\":[0.02868229049],\"passed_time\":0.2779986936,\"remaining_time\":1.078092495,\"test\":[0.9734847049,0.06155895575]},{\"iteration\":41,\"learn\":[0.02834713155],\"passed_time\":0.2814726358,\"remaining_time\":1.058873249,\"test\":[0.9713051059,0.06204408306]},{\"iteration\":42,\"learn\":[0.02792000797],\"passed_time\":0.2847872321,\"remaining_time\":1.039804545,\"test\":[0.9691823661,0.06245996545]},{\"iteration\":43,\"learn\":[0.02719840852],\"passed_time\":0.2885655366,\"remaining_time\":1.023095993,\"test\":[0.9690686479,0.06221107372]},{\"iteration\":44,\"learn\":[0.02686456815],\"passed_time\":0.2919973114,\"remaining_time\":1.005768517,\"test\":[0.96914446,0.06175663775]},{\"iteration\":45,\"learn\":[0.02684410804],\"passed_time\":0.2954632591,\"remaining_time\":0.9891596064,\"test\":[0.96914446,0.06172182948]},{\"iteration\":46,\"learn\":[0.02660353781],\"passed_time\":0.2989322575,\"remaining_time\":0.9731199021,\"test\":[0.9710397635,0.06153179207]},{\"iteration\":47,\"learn\":[0.02628627412],\"passed_time\":0.3026605836,\"remaining_time\":0.9584251815,\"test\":[0.9716273075,0.06158647803]},{\"iteration\":48,\"learn\":[0.0257633265],\"passed_time\":0.3063973568,\"remaining_time\":0.9442040995,\"test\":[0.9715135893,0.0615681207]},{\"iteration\":49,\"learn\":[0.02538824787],\"passed_time\":0.3100148874,\"remaining_time\":0.9300446621,\"test\":[0.9717410257,0.06175484742]},{\"iteration\":50,\"learn\":[0.02517782122],\"passed_time\":0.3135524631,\"remaining_time\":0.9160650393,\"test\":[0.97189265,0.06149597353]},{\"iteration\":51,\"learn\":[0.02480664803],\"passed_time\":0.3171983771,\"remaining_time\":0.9027953811,\"test\":[0.9691634131,0.06145539519]},{\"iteration\":52,\"learn\":[0.02465406462],\"passed_time\":0.3208409774,\"remaining_time\":0.8898796922,\"test\":[0.9707175619,0.06168958188]},{\"iteration\":53,\"learn\":[0.02449480468],\"passed_time\":0.3241478914,\"remaining_time\":0.8763998546,\"test\":[0.970755468,0.06172684385]},{\"iteration\":54,\"learn\":[0.02425119078],\"passed_time\":0.3276169906,\"remaining_time\":0.8637175206,\"test\":[0.970755468,0.06170700311]},{\"iteration\":55,\"learn\":[0.02402640128],\"passed_time\":0.3310488761,\"remaining_time\":0.8512685387,\"test\":[0.9704143133,0.06177924823]},{\"iteration\":56,\"learn\":[0.02375667229],\"passed_time\":0.3348574799,\"remaining_time\":0.840081046,\"test\":[0.9704143133,0.06230049627]},{\"iteration\":57,\"learn\":[0.02349315283],\"passed_time\":0.3382657847,\"remaining_time\":0.8281679557,\"test\":[0.9694287555,0.06257535926]},{\"iteration\":58,\"learn\":[0.02323039439],\"passed_time\":0.3419232776,\"remaining_time\":0.8171386805,\"test\":[0.9690496949,0.06288818412]},{\"iteration\":59,\"learn\":[0.02305986248],\"passed_time\":0.3453658259,\"remaining_time\":0.8058535937,\"test\":[0.9689359766,0.06308842921]}],\"meta\":{\"iteration_count\":200,\"launch_mode\":\"Train\",\"learn_metrics\":[{\"best_value\":\"Min\",\"name\":\"Logloss\"}],\"learn_sets\":[\"learn\"],\"name\":\"experiment\",\"parameters\":\"\",\"test_metrics\":[{\"best_value\":\"Max\",\"name\":\"AUC\"},{\"best_value\":\"Min\",\"name\":\"Logloss\"}],\"test_sets\":[\"test\"]}},\"passed_iterations\":59,\"total_iterations\":200},\"name\":\"catboost_info\",\"path\":\"catboost_info\"}},\"layout\":\"IPY_MODEL_29eea592a5354988a2cf1aba21d1f000\",\"tabbable\":null,\"tooltip\":null}}},\"version_major\":2,\"version_minor\":0}\n</script>\n"
      ]
    }
  }
}